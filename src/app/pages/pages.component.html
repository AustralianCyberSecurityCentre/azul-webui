<div
  class="min-h-full w-full"
  [ngClass]="{ 'flex h-screen flex-col': !hasScroll() }"
>
  <nav
    role="banner"
    class="dark bg-azul-500 sticky top-0 z-40 font-sans text-white shadow-lg shadow-black/20"
  >
    <div class="flex flex-col">
      <div
        class="grid w-full grid-cols-[minmax(max-content,1fr)_auto_1fr] gap-1 bg-red-900"
      >
        <div class="flex">
          <div class="flex w-fit items-center px-2 py-[1px] text-xs font-bold">
            {{ config?.deployment_text || "UNKNOWN DEPLOYMENT" }}
          </div>
        </div>
        <div>
          <button
            class="text-white-600 mx-auto flex h-full cursor-pointer appearance-none items-center gap-2 px-2 text-center text-xs font-bold uppercase transition-colors hover:bg-slate-600"
            (click)="dialogShow(tplSecurity)"
            aria-label="Max Security Picker"
          >
            <fa-icon [icon]="faSliders" />
            <b>
              {{ api.currentExclusions.length === 0 ? "" : "*" }}Max{{
                api.currentExclusions.length === 0 ? "" : "*"
              }}:
              {{ securityService.displayMaxSecurity$ | async }}
            </b>
          </button>
        </div>
      </div>
      <div class="flex w-full justify-between p-1">
        <div class="flex items-center">
          <a title="Home" [routerLink]="['/pages/home']">
            <div
              class="mx-1 [&_.cls-1]:fill-white [&_.cls-2]:fill-[#171a2f] hover:[&_.cls-2]:fill-[#fe00c2] [&_.cls-3]:fill-[#676f89] hover:[&_.cls-3]:fill-[#02fe73] [&_svg>*]:transition-colors [&_svg>*]:duration-1000"
            >
              <!-- SVG embedded instead of image to allow hover effects to work. If you use <img> hover won't work.-->
              <svg
                width="40"
                height="40"
                viewBox="0 0 273 249"
                aria-label="Azul Logo"
                role="img"
              >
                <path
                  class="cls-1"
                  d="M245.53,231.22l-26.54-71.81c-.44-1.18-1.56-1.96-2.82-1.96h-14.11c-1.66,0-3.01-1.35-3.01-3.01v-8.01c0-1.66,1.35-3.01,3.01-3.01h20.73c2.09,0,3.55-2.09,2.82-4.05L177.96,10.4c-2.31-6.25-8.26-10.4-14.92-10.4h-43.32c-1.26,0-2.39,.79-2.82,1.97l-4.42,12.05-40.83,111.32c-.72,1.96,.73,4.04,2.82,4.04h15.59c1.66,0,3.01,1.35,3.01,3.01v8.01c0,1.66-1.35,3.01-3.01,3.01H29.2c-1.66,0-3.01,1.35-3.01,3.01v8.01c0,1.66,1.35,3.01,3.01,3.01h19.41c1.66,0,3.01,1.35,3.01,3.01v8.01c0,1.66-1.35,3.01-3.01,3.01h-5.8c-1.26,0-2.39,.79-2.82,1.97L13.65,245.25c-.72,1.96,.73,4.04,2.82,4.04h57.68c1.32,0,2.48-.86,2.87-2.12l3.67-11.9,9.4-30.43c.39-1.26,1.55-2.12,2.87-2.12h77.92c1.32,0,2.48,.85,2.87,2.11l13.24,42.36c.39,1.26,1.55,2.11,2.87,2.11h46.83c1.66,0,3.01-1.35,3.01-3.01v-8.01c0-1.66,1.35-3.01,3.01-3.01h0c2.09,0,3.55-2.09,2.82-4.05Zm-88.02-78.79c.6,1.94-.84,3.9-2.87,3.9h-59.46c-2.02,0-3.47-1.96-2.87-3.89l2.13-6.9c.39-1.26,1.55-2.12,2.87-2.12h23.61c1.32,0,2.48-.86,2.87-2.12l19.2-62.16c.87-2.82,4.87-2.83,5.74,0l4.15,13.36,14.62,47.03c.6,1.94-.84,3.9-2.87,3.9h-5.86c-2.03,0-3.47,1.97-2.87,3.9l1.59,5.11Z"
                />
                <path
                  class="cls-3"
                  d="M100.95,202.71h-8.12c-1.24,0-2.33,.81-2.69,1.99l-9.44,30.57-3.2,10.37c-.56,1.81,.8,3.65,2.69,3.65h33.19c1.56,0,2.82-1.26,2.82-2.82v-8.39c0-1.56-1.26-2.82-2.82-2.82h-14.84c-1.9,0-3.25-1.84-2.69-3.65l7.8-25.25c.56-1.81-.8-3.65-2.69-3.65Z"
                />
                <path
                  class="cls-3"
                  d="M105.03,143.41h-7.71c-1.32,0-2.49,.86-2.88,2.13l-2.13,6.89c-.6,1.94,.85,3.9,2.88,3.9h7.71c1.32,0,2.49-.86,2.88-2.13l2.13-6.89c.6-1.94-.85-3.9-2.88-3.9Z"
                />
                <path
                  class="cls-3"
                  d="M125.82,143.41h9.88c.87,0,1.63-.57,1.89-1.39l8.31-26.9,6.81-22.05c.12-.38,.12-.79,0-1.17l-4.96-15.95c-.58-1.86-3.2-1.85-3.78,0l-20.05,64.9c-.39,1.27,.56,2.56,1.89,2.56Z"
                />
                <path
                  class="cls-3"
                  d="M227.68,143.41h29.22c1.39,0,2.52-1.13,2.52-2.52v-8.99c0-1.39-1.13-2.52-2.52-2.52h-19.19c-1.06,0-2-.66-2.36-1.65L188.76,1.65c-.37-.99-1.31-1.65-2.36-1.65h-8.65c-1.75,0-2.97,1.75-2.36,3.39l51.73,140.02h.58Z"
                />
                <path
                  class="cls-3"
                  d="M201.17,157.44h9.71c1.17,0,2.12-.95,2.12-2.12v-10.02c0-1.04-.84-1.89-1.89-1.89h-9.95c-1.17,0-2.12,.95-2.12,2.12v9.78c0,1.17,.95,2.12,2.12,2.12Z"
                />
                <path
                  class="cls-3"
                  d="M246.72,168.54v-8.18c0-1.61-1.31-2.92-2.92-2.92h-21.34c-2.03,0-3.44,2.03-2.74,3.93l25.85,69.96c.7,1.91-.71,3.93-2.74,3.93h-5.25c-1.61,0-2.92,1.31-2.92,2.92v8.18c0,1.61,1.31,2.92,2.92,2.92h24.46c2.03,0,3.44-2.03,2.74-3.93l-25.85-69.96c-.7-1.91,.71-3.93,2.74-3.93h2.13c1.61,0,2.92-1.31,2.92-2.92Z"
                />
                <rect
                  class="cls-3"
                  x="259.22"
                  y="157.44"
                  width="14.03"
                  height="14.02"
                  rx="2.69"
                  ry="2.69"
                />
                <rect
                  class="cls-2"
                  x="12.16"
                  y="143.41"
                  width="14.02"
                  height="14.03"
                  rx="2.6"
                  ry="2.6"
                />
                <path
                  class="cls-2"
                  d="M152.9,92.48l-6.99,22.63,7.89,25.4c.54,1.72,2.13,2.89,3.93,2.89h11l-15.83-50.93Z"
                />
                <path
                  class="cls-2"
                  d="M141.82,147.08l2.26,7.26c.37,1.18,1.46,1.99,2.7,1.99h8.1c1.91,0,3.27-1.85,2.7-3.67l-2.26-7.26c-.37-1.18-1.46-1.99-2.7-1.99h-8.1c-1.91,0-3.27,1.85-2.7,3.67Z"
                />
                <path
                  class="cls-2"
                  d="M159.82,205.11l12.57,40.21c.74,2.36,2.93,3.97,5.4,3.97h7.35c1.25,0,2.14-1.21,1.76-2.4l-13.41-42.88c-.24-.77-.96-1.3-1.76-1.3h-10.15c-1.25,0-2.14,1.21-1.76,2.4Z"
                />
                <path
                  class="cls-2"
                  d="M89.26,14.02h5.5c1.79,0,3.04,1.78,2.42,3.47L61.91,113.67c-.37,1.02-1.34,1.69-2.42,1.69h-9.58c-1.42,0-2.58,1.16-2.58,2.58v8.87c0,1.42,1.16,2.58,2.58,2.58h18.46c1.08,0,2.05-.68,2.42-1.69L112.48,14.02l3.87-10.56c.62-1.68-.63-3.47-2.42-3.47h-24.67c-1.42,0-2.58,1.16-2.58,2.58V11.44c0,1.42,1.16,2.58,2.58,2.58Z"
                />
                <rect
                  class="cls-2"
                  x="19.27"
                  y="101.33"
                  width="14.03"
                  height="14.03"
                  rx="2.95"
                  ry="2.95"
                />
                <rect
                  class="cls-2"
                  x="58.63"
                  y="14.02"
                  width="14.02"
                  height="14.03"
                  rx="2.6"
                  ry="2.6"
                />
                <rect
                  class="cls-2"
                  x="44.6"
                  y="28.05"
                  width="14.03"
                  height="14.02"
                  rx="2.22"
                  ry="2.22"
                />
                <path
                  class="cls-2"
                  d="M31.31,158.83L.27,243.48c-1.03,2.82,1.05,5.81,4.06,5.81h3.71c2.48,0,4.7-1.55,5.56-3.88l26.61-72.56c.31-.83,1.1-1.39,1.99-1.39h7.31c1.17,0,2.12-.95,2.12-2.12v-9.79c0-1.17-.95-2.12-2.12-2.12h-16.2c-.89,0-1.68,.55-1.99,1.39Z"
                />
              </svg>
            </div>
          </a>
          <div role="tablist" class="flex items-center">
            @if (
              (nav.topbarEntity$ | async) &&
              (nav.topbarEntityExtraInfo$ | async) === null
            ) {
              <ng-container
                *ngTemplateOutlet="
                  menuDropdown;
                  context: {
                    title: 'Binaries',
                    content: (nav.topbarEntity$ | async),
                    icon: faAngleDown,
                  }
                "
              />
            } @else {
              <ng-container
                *ngTemplateOutlet="
                  menuDropdown;
                  context: {
                    title: 'Binaries',
                    content: (nav.topbarEntityExtraInfo$ | async),
                    icon: faAngleDown,
                  }
                "
              />
            }
            <ng-template #binariesWithExtra>
              <ng-container
                *ngTemplateOutlet="
                  menuDropdown;
                  context: {
                    title: 'Binaries',
                    content: (nav.topbarEntityExtraInfo$ | async),
                    icon: faAngleDown,
                  }
                "
              />
            </ng-template>
            <ng-container
              *ngTemplateOutlet="
                menuDropdown;
                context: {
                  title: 'Sources',
                  content: (nav.topbarSource$ | async),
                  icon: faAngleDown,
                }
              "
            >
            </ng-container>
            <ng-container
              *ngTemplateOutlet="
                menuDropdown;
                context: {
                  title: 'Features',
                  content: (nav.topbarFeature$ | async),
                  icon: faAngleDown,
                }
              "
            >
            </ng-container>
            <ng-container
              *ngTemplateOutlet="
                menuDropdown;
                context: {
                  title: 'Plugins',
                  content: (nav.topbarPlugin$ | async),
                  icon: faAngleDown,
                }
              "
            >
            </ng-container>
          </div>
        </div>
        <div class="flex items-center">
          <ng-container
            *ngTemplateOutlet="
              menuDropdown;
              context: {
                title: 'External links',
                hideTitle: true,
                rightAlign: true,
                content: nav.topbarExternal,
                icon: faBars,
                useGrid: true,
              }
            "
          />
          <div class="flex gap-2 pr-2">
            <button
              class="transition-color text-md bg-azul-500 flex cursor-pointer appearance-none items-center gap-2 rounded-xs p-2 font-semibold lowercase hover:bg-slate-600 hover:text-white"
              tabindex="0"
              (click)="dialogShow(tplUserInfo)"
              aria-label="User Settings"
            >
              @if ((user.isUserAdmin$ | async) === true) {
                <fa-icon [icon]="faDragon" [size]="largeSizeIcon" />
              }
              <!--If initials are detected, display them as an icon-->
              @if (user.fmtUsername$ | async | userInitials; as initials) {
                <az-text-icon [label]="initials" />
              } @else {
                <!--If no initials are generated, use default icon as placeholder-->
                <fa-icon [icon]="faCircleUser" [size]="largeSizeIcon" />
              }

              <!--user.fmtUsername$ returns the users email with first letter capital, can come back here once you figure out-->
            </button>
            <button
              class="transition-color text-md bg-azul-500 flex cursor-pointer appearance-none items-center gap-2 rounded-xs p-2 font-semibold lowercase hover:bg-slate-600 hover:text-white"
              tabindex="0"
              (click)="securityService.reauthenticate()"
            >
              <fa-icon [icon]="faRightFromBracket" [size]="largeSizeIcon" />
            </button>
          </div>
        </div>
      </div>
    </div>
  </nav>
  <az-banners />

  <main
    [ngClass]="{
      'px-4 pt-8': hasMargin(),
      'flex min-h-0 flex-col *:flex *:min-h-0 *:grow *:flex-col': !hasScroll(),
    }"
    class="w-full min-w-0 shrink grow"
  >
    <router-outlet class="hidden!"></router-outlet>
  </main>
</div>

<ng-template #tplUserInfo>
  <flow-card>
    <flow-card-header
      [title]="user.username$ | async"
      [icon]="(user.fmtUsername$ | async | userInitials) ?? '??'"
    />
    <flow-card-body class="block h-[75vh] w-[80vw] overflow-auto">
      <flow-tablist
        [tabs]="[
          { name: 'Settings', template: userSettings },
          { name: 'Opensearch Access', template: userOpensearchAccess },
          { name: 'Restapi Access', template: userRestapiAccess },
        ]"
      />
    </flow-card-body>
  </flow-card>
</ng-template>

<ng-template #userSettings>
  <az-settings-overlay></az-settings-overlay>
</ng-template>

<ng-template #userRestapiAccess>
  @if ((user.isUserAdmin$ | async) === true) {
    <p>
      <strong>User is Admin</strong>&nbsp;
      <fa-icon class="fa-icon-green" [icon]="faCircleCheck" size="lg" />
    </p>
  }
  @if ((user.isUserAdmin$ | async) === false) {
    <p>
      <strong>User is not Admin</strong>&nbsp;
      <fa-icon class="fa-icon-red" [icon]="faCircleXmark" size="lg" />
    </p>
  }
  <br />
  <table flowTable>
    <thead flowTableHeader class="sticky top-0">
      <tr flowTableHeaderRow>
        <th flowTableHeaderCell>Restapi Roles from JWT</th>
      </tr>
    </thead>
    <tbody flowTableBody>
      @for (role of (user.userDetails$ | async)?.roles.toSorted(); track role) {
        <tr flowTableBodyRow>
          <td flowTableBodyCell>{{ role }}</td>
        </tr>
      }
    </tbody>
  </table>
</ng-template>

<ng-template #userOpensearchAccess>
  <table flowTable>
    <thead flowTableHeader class="sticky top-0">
      <tr flowTableHeaderRow>
        <th flowTableHeaderCell>Property</th>
        <th flowTableHeaderCell>Value</th>
      </tr>
    </thead>
    <tbody flowTableBody>
      <tr flowTableBodyRow>
        <td flowTableBodyCell>Metastore Security</td>
        <td flowTableBodyCell>
          {{
            (user.userDetailsOpensearch$ | async)?.security_enabled
              ? "Enabled"
              : "Disabled"
          }}
        </td>
      </tr>
      <tr flowTableBodyRow>
        <td flowTableBodyCell>Privileged Access</td>
        <td flowTableBodyCell>
          {{
            (user.userDetailsOpensearch$ | async)?.privileged ? "True" : "False"
          }}
        </td>
      </tr>
      <tr flowTableBodyRow>
        <td flowTableBodyCell>User Max Access</td>
        <td flowTableBodyCell>
          {{ (user.userDetailsOpensearch$ | async)?.security.max_access }}
        </td>
      </tr>
      <tr flowTableBodyRow>
        <td flowTableBodyCell>User Security Uniqueness</td>
        <td flowTableBodyCell>
          {{ (user.userDetailsOpensearch$ | async)?.security.unique }}
        </td>
      </tr>
    </tbody>
  </table>
  <br />
  <p><strong>User Security Labels</strong></p>
  <p>
    Note that 'Markings' don't have security enforced unless explicitly
    configured..
  </p>
  <table flowTable>
    <thead flowTableHeader class="sticky top-0">
      <tr flowTableHeaderRow>
        <th flowTableHeaderCell>Type</th>
        <th flowTableHeaderCell>Label</th>
      </tr>
    </thead>
    <tbody flowTableBody>
      @for (
        role of (
          user.userDetailsOpensearch$ | async
        )?.security.labels_exclusive.toSorted();
        track role
      ) {
        <tr flowTableBodyRow>
          <td flowTableBodyCell>Exclusive</td>
          <td flowTableBodyCell>{{ role }}</td>
        </tr>
      }
      @for (
        role of (
          user.userDetailsOpensearch$ | async
        )?.security.labels_inclusive.toSorted();
        track role
      ) {
        <tr flowTableBodyRow>
          <td flowTableBodyCell>Inclusive</td>
          <td flowTableBodyCell>{{ role }}</td>
        </tr>
      }
      @for (
        role of (
          user.userDetailsOpensearch$ | async
        )?.security.labels_markings.toSorted();
        track role
      ) {
        <tr flowTableBodyRow>
          <td flowTableBodyCell>Markings</td>
          <td flowTableBodyCell>{{ role }}</td>
        </tr>
      }
    </tbody>
  </table>
  <br />
  <p><strong>Opensearch Roles</strong></p>
  <table flowTable>
    <tbody flowTableBody>
      @for (
        role of (user.userDetailsOpensearch$ | async)?.roles.toSorted();
        track role
      ) {
        <tr flowTableBodyRow>
          <td flowTableBodyCell>{{ role }}</td>
        </tr>
      }
    </tbody>
  </table>
</ng-template>

<ng-template
  #menuDropdown
  let-title="title"
  let-content="content"
  let-icon="icon"
  let-hideTitle="hideTitle"
  let-rightAlign="rightAlign"
  let-useGrid="useGrid"
>
  <div class="group relative mx-2" tabindex="0">
    <div
      role="tab"
      class="transition-color text-md bg-azul-500 flex cursor-pointer items-center gap-2 rounded-xs p-2 font-semibold group-hover:bg-slate-600"
    >
      @if (!hideTitle) {
        {{ title }}
      }
      <fa-icon [icon]="icon" [size]="largeSizeIcon" />
    </div>
    <div
      aria-hidden="true"
      class="absolute top-0 z-30 hidden h-full w-24 group-hover:block group-active:block"
      [ngClass]="{ 'right-0': rightAlign, 'left-0': !rightAlign }"
    >
      <!-- Padding to increase the size of the hover area for small dropdowns -->
    </div>
    <div
      role="tabpanel"
      class="border-azul-600 bg-azul-500 shadow-azul-900/20 absolute top-full hidden w-52 border shadow-md group-hover:block group-active:block"
      [ngClass]="{ 'right-0 w-96': rightAlign }"
    >
      <ng-container
        *ngTemplateOutlet="
          menuList;
          context: { content: content, useGrid: useGrid }
        "
      ></ng-container>
    </div>
  </div>
</ng-template>

<ng-template #menuList let-content="content" let-useGrid="useGrid">
  <div [ngClass]="{ 'm-4 grid grid-cols-3 gap-4': useGrid }" role="tabpanel">
    @for (row of content; track row) {
      <ng-container
        *ngTemplateOutlet="menuItem; context: { row: row, useGrid: useGrid }"
      />
    }
  </div>
</ng-template>

<ng-template #menuItem let-row="row" let-useGrid="useGrid">
  @if (!row.disabled) {
    @if (row.external) {
      <ng-container
        *ngTemplateOutlet="
          externalMenuItem;
          context: { row: row, useGrid: useGrid }
        "
      />
    } @else {
      <ng-container
        *ngTemplateOutlet="
          internalMenuItem;
          context: { row: row, useGrid: useGrid }
        "
      />
    }
  } @else {
    <div
      class="cursor-default truncate p-2 font-semibold text-gray-700 dark:text-gray-400"
    >
      <ng-container
        *ngTemplateOutlet="
          menuItemInner;
          context: { row: row, useGrid: useGrid }
        "
      />
    </div>
  }
  <ng-template #disabled>
    <div
      class="cursor-default truncate p-2 font-semibold text-gray-700 dark:text-gray-400"
    >
      <ng-container
        *ngTemplateOutlet="
          menuItemInner;
          context: { row: row, useGrid: useGrid }
        "
      />
    </div>
  </ng-template>
</ng-template>

<ng-template #internalMenuItem let-row="row" let-useGrid="useGrid">
  <a
    [routerLink]="row.link"
    [fragment]="row.fragment"
    [ngClass]="{ 'bg-gray-300 dark:bg-gray-600': row.active }"
    role="tab"
    class="group block items-center gap-1 truncate p-2 text-sm font-semibold text-gray-900 hover:bg-gray-100 dark:text-white dark:hover:bg-gray-700"
  >
    <ng-container
      *ngTemplateOutlet="menuItemInner; context: { row: row, useGrid: useGrid }"
    />
  </a>
</ng-template>

<ng-template #externalMenuItem let-row="row" let-useGrid="useGrid">
  <a
    [href]="row.link"
    target="_blank"
    [ngClass]="{ 'bg-gray-300 dark:bg-gray-600': row.active }"
    role="tab"
    class="group block items-center gap-1 truncate p-2 text-sm font-semibold text-gray-900 hover:bg-gray-100 dark:text-white dark:hover:bg-gray-700"
  >
    <ng-container
      *ngTemplateOutlet="menuItemInner; context: { row: row, useGrid: useGrid }"
    />
  </a>
</ng-template>

<ng-template #menuItemInner let-row="row" let-useGrid="useGrid">
  <div class="flex" [ngClass]="{ 'flex-col place-items-center': useGrid }">
    {{ row.listItem ? "&bull;&nbsp;" : "" }}
    @if (row.icon) {
      <fa-icon [icon]="row.icon" size="xl" class="mb-2" />
    }
    <div class="truncate">
      {{ row.title }}
      @if (row.external) {
        <sup>
          <fa-icon [icon]="faUpRightFromSquare" size="sm" />
        </sup>
      }
      <br />
      @if (row.subtitle) {
        <p class="truncate text-xs dark:text-gray-400">
          {{ row.subtitle }}
        </p>
      }
    </div>
  </div>
</ng-template>

<ng-template #tplSecurity>
  <flow-card>
    <flow-card-header title="Security Limits" />
    <flow-card-body>
      <az-loading-card [obs$]="securityService.settings$">
        <az-security-limit
          [securitySettings]="securityService.settings$ | async"
          (submitLimits)="dialogClose()"
        >
        </az-security-limit>
      </az-loading-card>
    </flow-card-body>
  </flow-card>
</ng-template>

<ng-template #tplMotd>
  <flow-card>
    <flow-card-header [title]="config?.motd_header || 'Message of the Day'" />
    <flow-card-body>
      <flow-markdown
        [markdown]="config?.motd_body || 'no motd set'"
        [asQuote]="false"
      />
    </flow-card-body>
    <flow-card-footer>
      <flow-button (click)="dialogClose()">
        {{ config?.motd_footer || "Okay" }}
      </flow-button>
    </flow-card-footer>
  </flow-card>
</ng-template>
